{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .stock-price {
        font-size: 2.5rem;
        font-weight: 600;
    }
    .chart-container {
        height: 300px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Stock Header Section -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h3 mb-1">{{ stock.name }} ({{ stock.ticker }})</h1>
                            <div class="text-muted">{{ stock.exchange }}</div>
                        </div>
                        <div class="text-end">
                            <div class="stock-price">${{ (stock.current_price|default(0))|round(2) }}</div>
                            <div class="{% if stock.change_percent >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                {% if stock.change_percent >= 0 %}+{% endif %}${{ (stock.change|default(0))|round(2) }} ({{ (stock.change_percent|default(0))|round(2) }}%)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Chart -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Price History</h2>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active">1M</button>
                        <button type="button" class="btn btn-outline-primary">3M</button>
                        <button type="button" class="btn btn-outline-primary">6M</button>
                        <button type="button" class="btn btn-outline-primary">1Y</button>
                        <button type="button" class="btn btn-outline-primary">All</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stock Details -->
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Company Information</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Market Cap</th>
                                    <td>${{ ((stock.market_cap|default(0)) / 1000000000)|round(2) }}B</td>
                                </tr>
                                <tr>
                                    <th>P/E Ratio</th>
                                    <td>{{ (stock.pe_ratio|default(0))|round(2) }}</td>
                                </tr>
                                <tr>
                                    <th>Dividend Yield</th>
                                    <td>{{ (stock.dividend_yield|default(0))|round(2) }}%</td>
                                </tr>
                                <tr>
                                    <th>52-Week High</th>
                                    <td>${{ (stock.year_high|default(0))|round(2) }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Volume</th>
                                    <td>{{ (stock.volume|default(0))|int }}</td>
                                </tr>
                                <tr>
                                    <th>Avg Volume</th>
                                    <td>{{ (stock.avg_volume|default(0))|int }}</td>
                                </tr>
                                <tr>
                                    <th>EPS</th>
                                    <td>${{ (stock.eps|default(0))|round(2) }}</td>
                                </tr>
                                <tr>
                                    <th>52-Week Low</th>
                                    <td>${{ (stock.year_low|default(0))|round(2) }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if stock.description %}
                    <div class="mt-3">
                        <h3 class="h6 fw-bold">About {{ stock.name }}</h3>
                        <p>{{ stock.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recent Transactions -->
            {% if recent_transactions %}
            <div class="card shadow mb-4">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0">Your Recent Transactions</h2>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Shares</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.timestamp.strftime('%m/%d/%Y %H:%M') }}</td>
                                    <td class="{% if transaction.action == 'buy' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        {{ transaction.action|upper }}
                                    </td>
                                    <td>{{ transaction.quantity|int }}</td>
                                    <td>${{ transaction.price|round(2) }}</td>
                                    <td>${{ (transaction.quantity * transaction.price)|round(2) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-4">
            <!-- Trade Form -->
            <div class="card shadow mb-4 sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Place Order</h2>
                </div>
                <div class="card-body">
                    <form id="trade-form" method="POST" action="{{ url_for('trading.execute_trade') }}">
                        {{ trade_form.hidden_tag() }}
                        {{ trade_form.ticker }}
                        {{ trade_form.company_name }}
                        {{ trade_form.price }}
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Action</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="action" value="buy" id="action-buy" 
                                       {% if not user_holding %}checked{% endif %} autocomplete="off">
                                <label class="btn btn-outline-success" for="action-buy">Buy</label>
                                
                                <input type="radio" class="btn-check" name="action" value="sell" id="action-sell" 
                                       {% if not user_holding %}disabled{% endif %} autocomplete="off">
                                <label class="btn btn-outline-danger" for="action-sell">Sell</label>
                            </div>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label" for="quantity">Quantity</label>
                            {{ trade_form.quantity(class="form-control", type="number", min="1", step="1") }}
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Estimated Total</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control" id="estimated_total" readonly value="0.00">
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            {{ trade_form.make_public(class="form-check-input") }}
                            <label class="form-check-label" for="make_public">
                                Share this trade with followers
                            </label>
                        </div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label" for="trading_note">Trading Note (optional)</label>
                            {{ trade_form.trading_note(class="form-control", rows=2, placeholder="Why are you making this trade?") }}
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Submit Order</button>
                        </div>
                    </form>
                    
                    {% if user_holding %}
                    <div class="alert alert-info mt-3 mb-0">
                        <div class="fw-bold">Your Position</div>
                        <div class="d-flex justify-content-between">
                            <span>Shares Owned:</span>
                            <span>{{ user_holding.quantity|int }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Average Cost:</span>
                            <span>${{ (user_holding.average_price|default(0))|round(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Total Value:</span>
                            <span>${{ ((user_holding.quantity|default(0)) * (stock.current_price|default(0)))|round(2) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Profit/Loss:</span>
                            {% set pl = ((stock.current_price|default(0)) - (user_holding.average_price|default(0))) * (user_holding.quantity|default(0)) %}
                            {% set pl_percent = ((stock.current_price|default(0)) - (user_holding.average_price|default(0))) / (user_holding.average_price|default(1)) * 100 %}
                            <span class="{% if pl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                {% if pl >= 0 %}+{% endif %}${{ pl|round(2) }} ({{ pl_percent|round(2) }}%)
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Stock chart
        const ctx = document.getElementById('stockChart').getContext('2d');
        
        // Parse historical data passed from Python
        const historicalDataStr = '{{ historical_data|tojson|safe }}';
        let historicalData = [];
        try {
            historicalData = JSON.parse(historicalDataStr);
        } catch (e) {
            console.error("Error parsing historical data:", e);
            // Provide empty fallback data if parsing fails
            historicalData = [];
        }
        
        // Ensure we have valid data for the chart
        const dates = historicalData.map(item => item.date || '');
        const prices = historicalData.map(item => item.close || 0);
        
        // Only create chart if we have data and a canvas element
        if (ctx && dates.length > 0 && prices.length > 0) {
            const stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '{{ stock.ticker }} Price',
                        data: prices,
                        borderColor: '{{ stock.change_percent >= 0 and "#28a745" or "#dc3545" }}',
                        backgroundColor: '{{ stock.change_percent >= 0 and "rgba(40, 167, 69, 0.1)" or "rgba(220, 53, 69, 0.1)" }}',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    return `$${typeof value === 'number' ? value.toFixed(2) : '0.00'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (typeof value === 'number' ? value.toFixed(2) : '0.00');
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.log("Not creating chart due to missing data or canvas element");
        }
        
        // Calculate estimated total when quantity changes
        const tradeForm = document.getElementById('trade-form');
        
        if (tradeForm) {
            // Get stock price from the page to ensure consistent pricing
            let stockPrice = 0;
            try {
                stockPrice = parseFloat('{{ stock.current_price|default(0) }}') || 0;
                if (isNaN(stockPrice)) stockPrice = 0;
            } catch (e) {
                console.error("Error parsing stock price:", e);
                stockPrice = 0;
            }
            
            console.log("Stock price for calculations:", stockPrice);
            
            const hiddenPriceInput = tradeForm.querySelector('input[name="price"]');
            
            // Ensure the hidden price input has the correct value
            if (hiddenPriceInput) {
                hiddenPriceInput.value = stockPrice;
            }
            
            const quantityInput = tradeForm.querySelector('input[name="quantity"]');
            const estimatedTotalInput = document.getElementById('estimated_total');
            
            function updateEstimatedTotal() {
                if (quantityInput && estimatedTotalInput) {
                    let quantity = 0;
                    try {
                        quantity = parseFloat(quantityInput.value) || 0;
                        if (isNaN(quantity)) quantity = 0;
                    } catch (e) {
                        console.error("Error parsing quantity:", e);
                        quantity = 0;
                    }
                    
                    const total = (quantity * stockPrice).toFixed(2);
                    estimatedTotalInput.value = total;
                    console.log(`Calculating total: ${quantity} * ${stockPrice} = ${total}`);
                }
            }
            
            if (quantityInput) {
                // Prevent non-numeric input
                quantityInput.addEventListener('input', function(e) {
                    // Replace any non-digit characters except decimal point
                    this.value = this.value.replace(/[^\d.]/g, '');
                    // Ensure only one decimal point
                    if ((this.value.match(/\./g) || []).length > 1) {
                        this.value = this.value.replace(/\.+$/, '');
                    }
                    updateEstimatedTotal();
                });
                
                // Add event listeners for radio buttons to recalculate total when action changes
                const actionRadios = tradeForm.querySelectorAll('input[name="action"]');
                actionRadios.forEach(radio => {
                    radio.addEventListener('change', updateEstimatedTotal);
                });
                
                // Validate form before submission
                tradeForm.addEventListener('submit', function(e) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    if (quantity <= 0) {
                        e.preventDefault();
                        alert('Please enter a valid quantity greater than 0');
                        return false;
                    }
                    
                    // Double check that price is set
                    if (hiddenPriceInput && parseFloat(hiddenPriceInput.value) <= 0) {
                        hiddenPriceInput.value = stockPrice;
                    }
                    
                    return true;
                });
                
                // Initialize with default values
                updateEstimatedTotal();
            } else {
                console.error("Quantity input not found. Check the form field names.");
            }
        } else {
            console.error("Trade form element not found. Check the form ID.");
        }
    });
</script>
{% endblock %} 